<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YÃ¶netici Paneli</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f9f9f9; }
  .container { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
  h1,h2,h3 { margin-top:0; }
  .card { padding:15px; margin-bottom:12px; border:1px solid #ddd; border-radius:8px; background:#fff; }
  textarea, input { width:100%; padding:8px; margin-bottom:8px; }
  button { padding:8px 12px; cursor:pointer; margin-right:5px; }
  .posts-list div { margin-bottom:8px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>
</head>
<body>
<div class="container">
  <h1>YÃ¶netici Paneli</h1>

  <div style="margin-bottom:15px;">
  <button onclick="location.href='posts.html'">ğŸ“„ YazÄ±larÄ± GÃ¶r</button>
  <button onclick="location.href='index.html'">ğŸ  Ana Sayfa</button>
  </div>

  <div class="card">
    <h2>Site Bilgileri</h2>
    <label>HakkÄ±nda Metni</label>
    <textarea id="aboutInput"></textarea>
    <label>Kapak FotoÄŸrafÄ± (jpg/png)</label>
    <input type="file" id="coverUpload" accept="image/*">
    <button id="saveSiteMeta">Kaydet</button>
  </div>

  <div class="card">
    <h2>Yeni YazÄ±</h2>
    <input id="postTitle" placeholder="BaÅŸlÄ±k">
    <input id="postExcerpt" placeholder="KÄ±sa Ã¶zet (liste iÃ§in)">
    <label>Kapak (isteÄŸe baÄŸlÄ±)</label>
    <input type="file" id="postCover" accept="image/*">
    <label>Ä°Ã§erik (HTML veya markdown desteklenir)</label>
    <textarea id="postBody"></textarea>
    <div>
      <button id="publishPost">YayÄ±nla</button>
      <button id="saveDraft">Taslak Kaydet</button>
    </div>
  </div>

  <div class="card">
    <h2>Dosya YÃ¼kle</h2>
    <label>Dosya (pdf, docx, md)</label>
    <input type="file" id="fileUpload">
    <button id="uploadFileBtn">YazÄ± Olarak Ekle</button>

    <div id="loading" style="display:none; margin-top:10px; color:#555;">
       PDF iÅŸleniyor, lÃ¼tfen bekleyin...
    </div>

    <hr>
  </div>
  
  <div class="card">
    <h2>Mevcut Ä°Ã§erikler</h2>
    <div id="adminList" class="posts-list"></div>
  </div>
</div>

  
<script>
const editPost = JSON.parse(localStorage.getItem('editPost') || 'null');
let state = JSON.parse(localStorage.getItem('blog_state')||'{}');
let isAdmin = true;
localStorage.setItem('admin','1');

function fileToDataURL(file){ return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}

function saveSiteMeta(){
  if(!state.posts) state.posts = [];
  if(!state.siteMeta) state.siteMeta = {};
  state.siteMeta.about = document.getElementById('aboutInput').value;

  const f = document.getElementById('coverUpload').files[0];
  if(f){
    fileToDataURL(f).then(data=>{
      state.siteMeta.cover = data;
      localStorage.setItem('blog_state', JSON.stringify(state));
      alert('Kaydedildi');
    });
  }else{
    localStorage.setItem('blog_state', JSON.stringify(state));
    alert('Kaydedildi');
  }
}


document.getElementById('saveSiteMeta').onclick = saveSiteMeta;

function renderAdminList(){
  const el = document.getElementById('adminList');
  el.innerHTML = '';

  if(!state.posts) return;

  state.posts
    .sort((a,b)=> (b.date||'').localeCompare(a.date||''))
    .forEach(item=>{
      const div = document.createElement('div');
      div.textContent = item.title;
      el.appendChild(div);
    });
}

if(!state.posts) state.posts = [];
if(!state.siteMeta) state.siteMeta = {};
renderAdminList();
if (editPost) {
  document.getElementById('postTitle').value = editPost.title || '';
  document.getElementById('postExcerpt').value = editPost.excerpt || '';
  document.getElementById('postBody').value = editPost.body || '';

  // KullanÄ±cÄ±ya gÃ¶rsel ipucu
  document.querySelector('h2').innerText = 'YazÄ±yÄ± DÃ¼zenle';

  // Taslak / yayÄ±n bilgisi
  window.__editingPostId = editPost.id;
}


function savePost(published){
  const title = document.getElementById('postTitle').value.trim();
  const excerpt = document.getElementById('postExcerpt').value.trim();
  const body = document.getElementById('postBody').value.trim();
  const coverFile = document.getElementById('postCover').files[0];

  if(!title || !body){
    alert("BaÅŸlÄ±k ve iÃ§erik zorunlu");
    return;
  }

  // ğŸ§  EDIT MODE
  if (window.__editingPostId) {
    const post = state.posts.find(p => p.id === window.__editingPostId);
    if (!post) return alert("YazÄ± bulunamadÄ±");

    post.title = title;
    post.excerpt = excerpt;
    post.body = body;
    post.published = published;
    post.date = new Date().toISOString();

    if (coverFile) {
      fileToDataURL(coverFile).then(data => {
        post.cover = data;
        localStorage.setItem('blog_state', JSON.stringify(state));
        localStorage.removeItem('editPost');
        window.location.href = "posts.html";
      });
    } else {
      localStorage.setItem('blog_state', JSON.stringify(state));
      localStorage.removeItem('editPost');
      window.location.href = "posts.html";
    }

    return;
  }

  // ğŸ†• NEW POST
  const post = {
    id: Date.now().toString(),
    title,
    excerpt,
    body,
    published,
    date: new Date().toISOString()
  };

  if(coverFile){
    fileToDataURL(coverFile).then(data=>{
      post.cover = data;
      state.posts.push(post);
      localStorage.setItem('blog_state', JSON.stringify(state));
      window.location.href = "posts.html";
    });
  }else{
    state.posts.push(post);
    localStorage.setItem('blog_state', JSON.stringify(state));
    window.location.href = "posts.html";
  }
}

document.getElementById('publishPost').onclick = ()=>savePost(true);
document.getElementById('saveDraft').onclick = ()=>savePost(false);

document.getElementById('uploadFileBtn').onclick = async () => {
  const fileInput = document.getElementById('fileUpload');
  const file = fileInput.files[0];

  if (!file) {
    alert("LÃ¼tfen bir dosya seÃ§in");
    return;
  }

  const loadingEl = document.getElementById("loading");
  loadingEl.style.display = "block";
  if (loadingEl) loadingEl.style.display = "none";
  
  const ext = file.name.split('.').pop().toLowerCase();
  let content = "";

  try {
    // TXT / MD / HTML
    if (['txt', 'md', 'html'].includes(ext)) {
      content = await file.text();
    }

    // PDF (DONMAYAN VERSÄ°YON)
    else if (ext === 'pdf') {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let text = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const c = await page.getTextContent();
        text += c.items.map(it => it.str).join(" ") + "\n\n";

        // ğŸ§  Her 5 sayfada UI'ye nefes aldÄ±r
        if (i % 5 === 0) {
          await new Promise(requestAnimationFrame);
        }
      }

      content = `<pre>${text.replace(/[<>]/g, "")}</pre>`;
    }

    // DOCX
    else if (ext === 'docx') {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.convertToHtml({ arrayBuffer });
      content = result.value;
    }

    else {
      alert("Desteklenmeyen dosya tÃ¼rÃ¼");
      return;
    }

    const post = {
      id: Date.now().toString(),
      title: file.name.replace(/\.[^/.]+$/, ""),
      excerpt: "Dosyadan yÃ¼klenen iÃ§erik",
      body: content,
      published: true,
      date: new Date().toISOString()
    };

    if (!state.posts) state.posts = [];
    state.posts.push(post);
    localStorage.setItem('blog_state', JSON.stringify(state));

    window.location.href = "posts.html";

  } catch (err) {
    console.error(err);
    alert("Dosya iÅŸlenirken hata oluÅŸtu");
  } finally {
    loadingEl.style.display = "none";
  }
};

</script>
</body>
</html>
