<script>
const isAdmin = localStorage.getItem('admin') === '1';

let state;
try {
  state = JSON.parse(localStorage.getItem('blog_state'));
} catch {
  state = null;
}

function renderPosts(){
  const el = document.getElementById('postsList');
  el.innerHTML = '';

  if(!state){
    el.innerHTML = '<p>❌ blog_state bulunamadı</p>';
    return;
  }

  if(!Array.isArray(state.posts)){
    el.innerHTML = '<p>❌ posts listesi bulunamadı</p>';
    console.log('STATE:', state);
    return;
  }

  if(state.posts.length === 0){
    el.innerHTML = '<p>Henüz yazı yok.</p>';
    return;
  }

  state.posts
    .filter(p => p && (p.published || isAdmin))
    .sort((a,b)=> (b.date || '').localeCompare(a.date || ''))
    .forEach(p=>{
      const div = document.createElement('div');
      div.className = 'card';

      div.innerHTML = `
        <h3><a href="post.html?id=${p.id}">${p.title || 'Başlıksız'}</a></h3>
        <div class="meta">
          ${p.date ? new Date(p.date).toLocaleString() : ''}
          ${!p.published ? '(Taslak)' : ''}
        </div>
      `;

      if(isAdmin){
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Düzenle';
        btnEdit.onclick = ()=>location.href=`post.html?id=${p.id}`;

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Sil';
        btnDel.onclick = ()=>{
          if(confirm('Silinsin mi?')){
            state.posts = state.posts.filter(x=>x.id!==p.id);
            localStorage.setItem('blog_state', JSON.stringify(state));
            renderPosts();
          }
        };

        div.appendChild(btnEdit);
        div.appendChild(btnDel);
      }

      el.appendChild(div);
    });
}

renderPosts();
</script>
